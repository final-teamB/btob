<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.attachfile.AtchFileMapper">
    
    
    <!-- 2026.01.26. 파일 정보 단건 저장 -->
    <insert id="insertFile" 
    	parameterType="io.github.teamb.btob.dto.attachfile.AtchFileDto" 
    	useGeneratedKeys="true" 
    	keyProperty="fileId">
    	
	        INSERT INTO TB_ATCH_FILE_MST ( 
	            system_id, 
	            ref_id, 
	            org_file_nm, 
	            str_file_nm, 
	            file_path, 
	            file_ext, 
	            file_size,
	            upd_dtime
	        ) VALUES (
	            #{systemId}, 
	            #{refId}, 
	            #{orgFileNm}, 
	            #{strFileNm}, 
	            #{filePath}, 
	            #{fileExt}, 
	            #{fileSize},
	            #{updDtime}
	        )
        
    </insert>
    
    <!-- 2026.01.26. 파일 단건 상세 조회 (다운로드용)-->
    <select id="selectFileById" 
    	parameterType="java.util.Map" 
    	resultType="io.github.teamb.btob.dto.attachfile.AtchFileDto">
    	
        	SELECT 
        		file_id
				,system_id
				,ref_id
				,org_file_nm
				,str_file_nm
				,file_path
				,file_ext
				,file_size
				,reg_dtime
				,reg_id
				,upd_dtime
				,upd_id
				,use_yn
        	FROM TB_ATCH_FILE_MST 
        	WHERE 1=1
        	AND file_id = #{fileId}
        	AND ref_id = #{refId}
        	AND system_id = #{systemId} 
		    AND use_yn = 'Y'
        
    </select>

	<!-- 2026.01.26. 참조 대상별 파일 목록 조회 -->
    <select id="selectFileListByRef" 
    	parameterType="map" 
    	resultType="io.github.teamb.btob.dto.attachfile.AtchFileDto">
        
	        SELECT 
	        	file_id
				,system_id
				,ref_id
				,org_file_nm
				,str_file_nm
				,file_path
				,file_ext
				,file_size
				,reg_dtime
				,reg_id
				,upd_dtime
				,upd_id
				,use_yn
	        FROM 
	       		TB_ATCH_FILE_MST
	        WHERE 1=1 
		    AND system_id = #{systemId} 
		    AND ref_id = #{refId} 
		    AND use_yn = 'Y'
	        	
    </select>

    <!-- 2026.01.26. 첨부 파일 수정 시 삭제 처리 ( 미사용으로 변경 처리 ) -->
    <update id="updateUnusedFilesExceptRemaining" 
    	parameterType="java.util.Map">
    
		    UPDATE 
		    	TB_ATCH_FILE_MST
    		SET 
    			use_yn = 'N'
        		,upd_dtime = CURRENT_TIMESTAMP
        		,upd_id = #{userNo}
    		WHERE 1=1
    		AND ref_id = #{refId}
      		AND system_id = #{systemId}
      		AND use_yn = 'Y'
			<if test="remainingFileNames != null and remainingFileNames.size() > 0">
			AND str_file_nm NOT IN 
				<foreach item="strFileNm" 
					collection="remainingFileNames" 
					open="(" separator="," close=")">
				    
				    #{strFileNm}
				    
				</foreach>
			</if>
			
	</update>
	
	<!-- 일반 미사용 처리 -->
	<update id="unUseAtchFile"
		parameterType="java.util.Map">
		
			UPDATE
				TB_ATCH_FILE_MST
			SET
				use_yn = 'N'
        		,upd_dtime = CURRENT_TIMESTAMP
        		,upd_id = #{userId}
			WHERE ref_id IN
			<foreach item="refId" 
				collection="refIds" 
				open="(" separator="," close=")">
				
        		#{refId}
        		
    		</foreach>
			
	</update>
	
	
	<!-- 세부정보에서 수정 시 사용여부를 동적 처리하는게 필요함 -->
	<update id="updateUseYnByDetailInfoChg"
		parameterType="java.util.Map">
	
			UPDATE
				TB_ATCH_FILE_MST
			SET
				use_yn = #{useYn}
			WHERE file_id = #{fileId}
			AND str_file_nm = #{strFileNm}
	
	</update>
	
	<!-- 세부정보에서 수정 시 아이디랑 변환파일명따와야함.. -->
	<select id="selectFileIdStrFileNm"
		parameterType="java.util.Map"
		resultType="io.github.teamb.btob.dto.attachfile.AtchFileDto">
	
			SELECT
				file_id
				,str_file_nm
			FROM
				TB_ATCH_FILE_MST
			WHERE 1=1
			AND ref_id = #{refId}
			AND system_id = #{systemId}
			AND use_yn = 'Y'
		
	</select>
</mapper>