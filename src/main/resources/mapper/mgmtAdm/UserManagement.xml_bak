<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.mgmtAdm.UserMgmtAdmMapper">

	<sql id="searchCondi">
	
		AND ( 
			        a.user_id LIKE CONCAT('%', #{searchCondition}, '%') 
			        OR a.user_nm LIKE CONCAT('%', #{searchCondition}, '%') 
					OR b.company_name LIKE CONCAT ('%', #{searchCondition}, '%' ) 
					OR c.comm_name LIKE CONCAT ('%', #{searchCondition}, '%') 
				)
				
	</sql>


	<!-- 사용자관리 검색 조회 -->
	<select id="selectUserSearchConditionListAdm"
		parameterType="java.util.Map"
		resultType="io.github.teamb.btob.dto.mgmtAdm.user.SearchConditionUserDTO">

			SELECT
				ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) AS rownm
				,a.user_no
				,a.user_id
				,a.user_nm
				,b.company_name
				,a.user_type
				,a.app_status
				,a.acc_status
				,a.reg_dtime
				,a.upd_dtime
			FROM 
				TB_USERS a,
				TB_COMPANIES b
			WHERE 1=1
			AND a.company_cd = b.company_cd
			<if test="searchCondition != null and searchCondition.trim() != ''">
			    <include refid="searchCondi" />
			</if>
			ORDER BY ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) DESC
			LIMIT #{startRow}, #{limit}
	
	</select>
	
	<!-- 사용자 관리 검색 조회 건수  -->
	<select id="selectUserSearchConditionListCntAdm"
		parameterType="String"
		resultType="int">

			SELECT
				COUNT(a.user_no)
			FROM
				TB_USERS a,
				TB_COMPANIES b
			WHERE 1=1
			AND a.company_cd = b.company_cd
			<if test="searchCondition != null and searchCondition.trim() != ''">
			    <include refid="searchCondi" />
			</if>
		
	</select>
	
	<!-- 사용자 관리 상세 정보 -->
	<select id="selectUserDetailInfoByIdAdm"
		parameterType="int"
		resultType="io.github.teamb.btob.dto.mgmtAdm.user.SearchDetailInfoUserDTO">
	
			SELECT
				a.user_no,
				a.user_id,
				a.password,
				a.user_name,
				a.phone,
				a.email,
				b.company_name,
				a.address,
				a.detailAddress,
				a.postcode,
				a.businessNumber,
				a.position,
				b.master_name,
				a.user_type,
				fnc_get_app_stts_nm(a.app_status) AS app_status,
				fnc_get_acc_stts_nm(a.acc_status) AS acc_status,
				a.reg_dtime,
				a.upd_dtime,
				a.use_yn			 
			FROM
				TB_USERS a,
				TB_COMPANIES b
			WHERE 1=1
			AND a.company_cd = b.company_cd 
			AND a.user_no = #{userNo}
	
	</select>
	
	<!-- 사용자 등록 회원가입 상황 확인 필요-->
	<insert id=""></insert>
	
	<!-- 사용자 상세정보 등록 회원가입 상황 확인 필요 -->
	<insert id=""></insert>
	
	<!-- 사용자 정보 수정 비밀번호 제외 -->
	<update id="updateUserAdm" 
		parameterType="io.github.teamb.btob.dto.mgmtAdm.user.UpdateUserAdmDTO">
		    UPDATE 
		    	TB_USERS 
		    SET 
		        user_name = #{userName},
		        phone = #{phone},
		        email = #{email},
		        address = #{address},
		        detail_address = #{detailAddress},
		        postcode = #{postcode},
		        position = #{position},
		        user_type = #{userType},
		        app_status = #{appStatus},
		        acc_status = #{accStatus},
		        password = COALESCE(NULLIF(#{newPassword}, ''), password),  <!-- newPassword가 비어있으면 기존값 유지 -->
		        use_yn = #{useYn},
		        upd_dtime = CURRENT_TIMESTAMP,
		        upd_id = #{updId}
		    WHERE user_no = #{userNo}
	</update>
	
	<!-- 사용자 비밀번호 변경 -->
	<update id="updateUserPassword" 
		parameterType="io.github.teamb.btob.dto.mgmtAdm.user.UpdateUserPwdDTO">
		    UPDATE 
		    	TB_USERS 
		    SET 
		    	password = #{newPassword},
		        upd_dtime = CURRENT_TIMESTAMP,
		        upd_id = #{updId}
		    WHERE user_no = #{userNo}
		    AND password = #{password}  
	</update>
	
	<!-- 사용자 미사용 처리 -->
	<update id="UnUserByIdAdm"
		parameterType="io.github.teamb.btob.dto.mgmtAdm.user.UnUserAdmDTO">
		
			UPDATE
				TB_USERS
			SET
				accStatus = #{accStatus},
				upd_dtime = CURRENT_TIMESTAMP,
		        upd_id = #{updId},
		        use_yn = #{useYn}
		    WHERE user_no = #{userNo}
	
	</update>
</mapper>