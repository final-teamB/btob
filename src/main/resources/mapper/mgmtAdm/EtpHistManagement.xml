<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.mgmtAdm.EtpHistMgmtAdmMapper">

	<sql id="searchCondi">
	
		AND ( 
			        a.etp_id LIKE CONCAT('%', #{searchCondition}, '%')
			        OR c.user_name LIKE CONCAT('%', #{searchCondition}, '%')
					OR d.user_name LIKE CONCAT ('%', #{searchCondition}, '%')
					OR a.rejt_rsn LIKE CONCAT ('%', #{searchCondition}, '%')
					OR b.etp_stts_nm LIKE CONCAT ('%', #{searchCondition}, '%')
				)
				
	</sql>

	<!-- 히스토리 검색 조회 -->
	<select id="selectEtpHistSearchConditioinListAdm"
		parameterType="java.util.Map"
		resultType="io.github.teamb.btob.dto.mgmtAdm.hist.SearchEtpHistListDTO">
		
			SELECT
				ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) AS rownm
				,a.etp_id
				,b.etp_stts_nm AS etpSttsNm
				,c.user_name AS requestUserNm
				,a.reg_dtime
				,d.user_name AS apprUserNm
				,a.appr_dtime
				,a.rejt_rsn
			FROM
				TB_ETP_HIST a
				,TB_ETP_STTS_CD b
				,TB_USERS c
				,TB_USERS d
				
			WHERE 1=1
			AND a.etp_stts_cd = b.etp_stts_cd
			AND a.request_user_id = c.user_id
			AND a.appr_user_id = d.user_id
			<if test="searchCondition != null and searchCondition.trim() != ''">
				<include refid="searchCondi" />
			</if>
			ORDER BY ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) DESC
			<if test='isExcel == null or isExcel != "Y"'>
			    <if test="startRow != null and limit != null">
			        LIMIT #{startRow}, #{limit}
			    </if> 
			</if>
	
	</select>
	
	<!-- 히스토리 검색 조회 건수 -->
	<select id="selectEtpHistSearchConditioinListCntAdm"
		resultType="int">
	
			SELECT 
				COUNT(a.etp_id) 
			FROM
				TB_ETP_HIST a
				,TB_ETP_STTS_CD b
				,TB_USERS c
				,TB_USERS d
				
			WHERE 1=1
			AND a.etp_stts_cd = b.etp_stts_cd
			AND a.request_user_id = c.user_id
			AND a.appr_user_id = d.user_id
			<if test="searchCondition != null and searchCondition.trim() != ''">
				<include refid="searchCondi" />
			</if>
	
	</select>
	
	<!-- 히스토리 개별 조회 -->
	<select id="selectEtpHistListById"
		parameterType="int"
		resultType="io.github.teamb.btob.dto.mgmtAdm.hist.SearchEtpHistListDTO">
	
			SELECT
				ROW_NUMBER() OVER (ORDER BY reg_dtime ASC) AS rownm
				,fnc_get_etp_sttsnm(etp_stts_cd) AS etpSttsNm
				,fnc_get_usernm(request_user_id) AS requestUserNm
				,fnc_get_usernm(appr_user_id) AS apprUserNm
				,rejt_rsn
				,reg_dtime
				,appr_dtime
			FROM
				TB_ETP_HIST
			WHERE etp_id = #{etpId}
			ORDER BY ROW_NUMBER() OVER (ORDER BY reg_dtime ASC) DESC
	
	</select>
	
	<!-- 히스토리 개별 조회 건수 -->
	<select id="selectEtpHistListCntById"
		parameterType="int"
		resultType="int">
		
			SELECT
				COUNT(etp_id)
			FROM
				TB_ETP_HIST
			WHERE etp_id = #{etpId}
		
	</select>

</mapper>