<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.mgmtAdm.EstMgmtAdmMapper">
	
	<sql id="searchCondi">
	
		AND ( 
			        a.est_no LIKE CONCAT('%', #{searchCondition}, '%')
			        OR a.ctrt_nm LIKE CONCAT('%', #{searchCondition}, '%')
					OR b.user_name LIKE CONCAT ('%', #{searchCondition}, '%' )
					OR c.company_name LIKE CONCAT ('%', #{searchCondition}, '%')
				)
				
	</sql>
	
	
	<!-- 견적서 조회 -->
	<select id="selectEstMstListAdm"
		parameterType="java.util.Map"
		resultType="io.github.teamb.btob.dto.mgmtAdm.EstMgmtAdmDTO">
		
			SELECT
				ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) AS rownm
				,a.est_no
				,a.ctrt_nm
				,a.ttl_est_amt
				,a.est_stts_cd
				,b.user_name,
				,c.company_name
				,a.reg_dtime
				,a.upd_dtime
				,a.expire_dtime
				,a.use_yn
			FROM
				TB_EST_MST a,
				TB_USERS b,
				TB_COMPANIES c
			WHERE 1 = 1
				AND a.reg_id = b.user_id
				AND b.company_cd = c.company_cd
				<if test="searchCondition != null and searchCondition.trim() != ''">
			       <include refid="searchCondi" />
			    </if>
			ORDER BY ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) DESC
			LIMIT #{startRow}, #{limit}
		 
	</select>
	
	<!-- 견적서 조회 건수 -->
	<select id="countEstMstListCntAdm"
		parameterType="String"
		resultType="int">
		
			SELECT
				COUNT(a.est_id)
			FROM
				TB_EST_MST a,
				TB_USERS b,
				TB_COMPANIES c
			WHERE 1 = 1
				AND a.reg_id = b.user_id
				AND b.company_cd = c.company_cd
				<if test="searchCondition != null and searchCondition.trim() != ''">
			       <include refid="searchCondi" />
			    </if>
		    
	</select>
	
	<!-- 견적서 상세 조회 ( 견적서 출력 시에 사용 ) 
		장바구니는 cart서비스에서 당겨올것
		a.target_unit_prc 희망단가 를 물품하고 받아서 리스트로 당겨서
		a.ttl_est_amt 예상총액 계산해야하는데 좀 회의 필요
		사용자를 userNo로 판가름할지 userId로 할지 생각해야함
		-->
	<select id="selectEstMstInfoByIdAdm"
		parameterType="int"
		resultType="io.github.teamb.btob.dto.mgmtAdm.EstMgmtAdmDTO">
		
			SELECT 
				,a.est_id	-- 견적서식별번호
				,a.est_no	-- 견적서NO
				,a.ctrt_nm	-- 계약명
				,-- a.target_unit_prc	-- 희망단가
				,-- a.ttl_est_amt	-- 예상총액
				,a.estdt_memo	-- 요청상세내용
				,a.est_stts_cd	-- 견적상태코드
				,a.expire_dtime	-- 견적 유효 기한
				,c.user_name	-- 요청자 서명
				,d.company_name -- 요청 회사명
				,d.company_phone -- 요청 회사 연락처
				,e.user_name		-- 승인자
				,b.rejt_rsn		-- 반려시 반려 사유
				,a.reg_dtime		-- 생성일자
				,a.upd_dtime		-- 수정일자
				,a.upd_id		-- 수정자
				,a.use_yn		-- 조회여부
			FROM 
				TB_EST_MST a,
				TB_EST_HIST b,
				TB_USERS c,
				TB_COMPANIES d,
				TB_USERS e
			WHERE 1=1
			AND a.est_id = b.est_id
			AND a.reg_id = c.user_no
			AND c.company_cd = d.company_cd
			AND b.appr_user_id = e.user_no
			AND a.est_id = #{estId}
		
	</select>
	
	<select id="selectEstMstInfoCartList">
	
		SELECT 
			product_id -- 상품명
			total_qty -- 수량
			target_unit_prc -- 희망단가
			ttl_est_amt -- 예상 견적 총액
		FROM
			TB_CART
		WHERE 
	
	</select>

</mapper>