<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.mgmtAdm.ProductMgmtAdmMapper">

	<sql id="oilMstJoins">
	
				LEFT OUTER JOIN COMMON_TBL b 
					ON a.fuel_cat_cd = b.comm_no 
					AND b.param_value = 'FUEL_CAT'
				LEFT OUTER JOIN COMMON_TBL c 
					ON a.origin_cntry_cd = c.comm_no 
					AND c.param_value = 'COUNTRY'
				LEFT OUTER JOIN COMMON_TBL d 
					ON a.vol_unit_cd = d.comm_no 
					AND d.param_value = 'VOL_UNIT'
				LEFT OUTER JOIN COMMON_TBL e 
					ON a.item_stts_cd = e.comm_no 
					AND e.param_value = 'FUEL_ITEM_STTS'
					
	</sql>
	
	<sql id="searchCondi">
	
		AND ( 
			        a.fuel_cd LIKE CONCAT('%', #{searchCondition}, '%') -- 유류코드
			        OR a.fuel_nm LIKE CONCAT('%', #{searchCondition}, '%') -- 유류명칭
					OR b.comm_name LIKE CONCAT ('%', #{searchCondition}, '%' ) -- 유류종류
					OR c.comm_name LIKE CONCAT ('%', #{searchCondition}, '%') -- 원산지국가
				)
				
	</sql>


	<!-- 조회 -->
	<select id="selectProductSearchConditionListAdm"
		parameterType="java.util.Map"
		resultType="io.github.teamb.btob.dto.mgmtAdm.product.SearchConditionProductDTO">
	
			SELECT
				ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) AS rownm
				,a.fuel_id
				,a.fuel_cd
				,a.fuel_nm
				,b.comm_name AS fuel_cat_nm       /* 유류종류 명칭 */
				,c.comm_name AS origin_cntry_nm   /* 원산지 국가 명칭 */
				,a.base_unit_prc
				,a.curr_stock_vol
				,a.safe_stock_vol
				,d.comm_name AS vol_unit_nm       /* 유류단위 명칭 */
				,e.comm_name AS item_stts_nm      /* 재고상태 명칭 */
				,a.reg_dtime
				,a.upd_dtime
				,a.use_yn
			FROM
				TB_OIL_MST a
			<include refid="oilMstJoins" />
			WHERE 1=1
			<if test="searchCondition != null and searchCondition.trim() != ''">
		       <include refid="searchCondi" />
		    </if>
		    ORDER BY ROW_NUMBER() OVER (ORDER BY a.reg_dtime ASC) DESC
			<if test="startRow != null and limit != null">
            	LIMIT #{startRow}, #{limit}
        	</if>
			
	</select>
	
	<!-- 조회 건수 -->
	<select id="selectProductSearchConditionListCntAdm" 
		parameterType="String"
		resultType="int">
		
			SELECT 
				COUNT(a.fuel_id)
			FROM
				TB_OIL_MST a
			<include refid="oilMstJoins" />
			WHERE 1 = 1
			<if test="searchCondition != null and searchCondition.trim() != ''">
			    <include refid="searchCondi" />
			</if>
	
	</select>
	
	<!-- 상세조회 -->
	<select id="selectProductDetailInfoByIdAdm"
		parameterType="int"
		resultType="io.github.teamb.btob.dto.mgmtAdm.product.SearchDetailInfoProductDTO">
	
			SELECT
				a.fuel_id
		        ,a.fuel_cd
		        ,a.fuel_nm
		        ,a.fuel_cat_cd
		        ,fnc_get_commnm(a.fuel_cat_cd) AS fuel_cat_nm   /* 유류종류 명칭 */
		        ,a.origin_cntry_cd
		        ,fnc_get_commnm(a.origin_cntry_cd) AS origin_cntry_nm /* 원산지 국가 명칭 */
		        ,a.base_unit_prc
		        ,a.curr_stock_vol
		        ,a.safe_stock_vol
		        ,a.vol_unit_cd
		        ,fnc_get_commnm(a.vol_unit_cd) AS vol_unit_nm           /* 유류단위 명칭 */
		        ,a.item_stts_cd
		        ,fnc_get_commnm(a.item_stts_cd) AS item_stts_nm    /* 재고상태 명칭 */
		        ,a.reg_dtime
		        ,a.reg_id
		        ,fnc_get_usernm(a.reg_id) AS reg_nm                             
		        ,a.upd_dtime
		        ,a.upd_id
		        ,fnc_get_usernm(a.upd_id) AS upd_nm                             
		        ,a.use_yn
		        ,f.api_grv
		        ,f.sulfur_pcnt
		        ,f.flash_pnt
		        ,f.viscosity
		        ,f.density_15c
			FROM
				TB_OIL_MST a
				LEFT OUTER JOIN TB_OIL_MST_DETAIL b
					ON a.fuel_id = b.fuel_id
			WHERE 1=1
			AND a.use_yn = 'Y'
			AND a.fuel_id = #{fuelId}
	
	</select>
	
	<!-- 상품 등록 -->
	<insert id="insertProductAdm"
		parameterType="io.github.teamb.btob.dto.mgmtAdm.product.InsertProductDTO"
		useGeneratedKeys="true" 
        keyProperty="fuelId">
		
			INSERT INTO TB_OIL_MST (
					fuel_cd
					,fuel_nm
					,fuel_cat_cd
					,origin_cntry_cd
					,base_unit_prc
					,curr_stock_vol
					,safe_stock_vol
					,vol_unit_cd
					,item_stts_cd
					,reg_id
					,use_yn
				) VALUES (
					 #{fuelCd}
					,#{fuelNm}
					,#{fuelCatCd}
					,#{originCntryCd}
					,#{baseUnitPrc}
					,#{currStockVol}
					,#{safeStockVol}
					,#{volUnitCd}
					,#{itemSttsCd}
					,#{regId}
					,#{useYn}
				)
	
	</insert>
	
	<!-- 상품 상세정보 등록 -->
	<insert id="insertProductDetailInfoAdm"
		parameterType="io.github.teamb.btob.dto.mgmtAdm.product.InsertDetailInfoProductDTO">
		
			INSERT INTO TB_OIL_MST_DETAIL (
					,fuel_id
					,api_grv
					,sulfur_p_cnt
					,flash_pnt
					,viscosity
					,density_15c
					,reg_id
					,use_yn
				) VALUES (
					 #{fuelId}
					,#{apiGrv}
					,#{sulfurPCnt}
					,#{flashPnt}
					,#{viscosity}
					,#{density15c}
					,#{regId}
					,#{useYn}
				)    
					
	</insert>
	
	<!-- 상품 수정 -->
	<update id="updateProductAdm"
		parameterType="io.github.teamb.btob.dto.mgmtAdm.product.UpdateProductDTO">
	
			UPDATE 
		        TB_OIL_MST
		    SET
		        fuel_cd          = #{fuelCd},
		        fuel_nm          = #{fuelNm},
		        fuel_cat_cd      = #{fuelCatCd},
		        origin_cntry_cd  = #{originCntryCd},
		        base_unit_prc    = #{baseUnitPrc},
		        curr_stock_vol   = #{currStockVol},
		        safe_stock_vol   = #{safeStockVol},
		        vol_unit_cd      = #{volUnitCd},
		        item_stts_cd     = #{itemSttsCd},
		        use_yn           = #{useYn},
		        upd_dtime        = CURRENT_TIMESTAMP,
		        upd_id           = #{updId}
		    WHERE 
		        fuel_id = #{fuelId}
			
	</update>
	
	<!-- 상품 상세정보 수정 -->
	<update id="updateProductDetailInfoAdm"
		parameterType="io.github.teamb.btob.dto.mgmtAdm.product.UpdateProductDetailInfoDTO">
		
			UPDATE 
		        TB_OIL_MST_DETAIL
		    SET
		        api_grv         = #{apiGrv},         
		        sulfur_p_cnt    = #{sulfurPCnt},     
		        flash_pnt       = #{flashPnt},       
		        viscosity       = #{viscosity},      
		        density_15c     = #{density15c},     
		        use_yn          = #{useYn},
		        upd_dtime       = CURRENT_TIMESTAMP,
		        upd_id          = #{updId}
		    WHERE 
		    	fuel_id = #{fuelId}
		
	</update>
	
	<!-- 상품 미사용처리 -->
	<update id="deleteProductByIdAdm"
		parameterType="int">
		
			UPDATE
				TB_OIL_MST
			SET
				use_yn          = #{useYn},
		        upd_dtime       = CURRENT_TIMESTAMP,
		        upd_id          = #{updId}
		    WHERE 
		    	fuel_id = #{fuelId}
		    	 
	</update>
	
	<!-- 상품 상세정보 미사용처리 -->
	<update id="deleteProductDetailInfoByIdAdm"
		parameterType="int">
	
			UPDATE
				TB_OIL_MST_DETAIL
			SET
				use_yn          = #{useYn},
		        upd_dtime       = CURRENT_TIMESTAMP,
		        upd_id          = #{updId}
		    WHERE 
		    	fuel_id = #{fuelId}
		    	
	</update>
	
</mapper>