<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.cart.CartMapper">

	<!-- 카트에 담긴 상품 조회 -->
	<select id="selectCartItemList" resultType="io.github.teamb.btob.dto.cart.CartItemDTO">
	    SELECT
	        c.cart_id,
	        c.user_id,
	        c.fuel_id,
	        c.total_qty,
	        c.total_price,
	        c.cart_status,
	        o.fuel_nm,
	        o.fuel_cd,
	        o.fuel_Cat_Cd,
	        o.origin_Cntry_cd,
	        o.base_unit_prc
	    FROM TB_CART c
	    	JOIN TB_OIL_MST o
	    	ON c.fuel_id = o.fuel_id  
	    WHERE c.user_id = #{userId}
	      AND c.cart_status IN ('PENDING', 'REQ', 'APPROVED')
	</select>
	
	<!-- 이미 있는 상품인지 조회 -->
	<select id="selectExistingCartItem" resultType="io.github.teamb.btob.dto.cart.CartItemInsertDTO">
	    SELECT
	        cart_id,
	        user_id,
	        fuel_id,
	        total_qty,
	        total_price,
	        cart_status
	    FROM TB_CART
	    WHERE user_id = #{userId}
	      AND fuel_id = #{fuelId}
	      AND cart_status = 'PENDING'
	</select>
	
	<select id="getCartStatusByUser" parameterType="String" resultType="String">
	    SELECT cart_status
	    FROM TB_CART
	    WHERE user_id = #{userId}
	</select>
	
	<!-- 카트에 상품 추가 -->
	<insert id="insertCartItem">
	    INSERT INTO TB_CART (
	        user_id,
	        fuel_id,
	        total_qty,
	        total_price,
	        cart_status,
	        reg_id
	    ) VALUES (
	        #{userId},
	        #{fuelId},
	        #{totalQty},
	        #{totalPrice},
	        #{cartStatus},
	        #{userId}
	    )
	</insert>
	
	<!-- 카트에서 상품 수량 변경 -->
	<update id="updateCartItem">
	    UPDATE TB_CART
	    SET
	        total_qty   = #{totalQty},
	        total_price = #{totalPrice},
	        upd_dtime   = NOW(),
	        upd_id      = #{userId}
	    WHERE cart_id = #{cartId}
	</update>
	
	<!-- 카트에서 삭제 -->
	<delete id="deleteCartItem">
		DELETE FROM TB_CART
		WHERE cart_id = #{cartId}
	      AND user_id = #{userId}	
	</delete>
	
	<delete id="clearCart">
	    DELETE FROM TB_CART
	    WHERE user_id = #{userId}
	</delete>
</mapper>