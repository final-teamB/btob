<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.teamb.btob.mapper.document.TradeDocMapper">
		
		<select id="getOrderDetailList" resultType="io.github.teamb.btob.dto.trade.TradePendingDTO">
		SELECT 
	        O.order_id,
	        O.order_no,
	        O.est_id,
	        O.order_status,
	        O.reg_dtime,
	        C.cart_id,
	        F.fuel_nm,
	        C.total_qty,
	        C.total_price,
	        F.base_unit_prc,
	        U.user_no,
	        U.user_id,
	        U.user_name,
	        U.phone,
	        CO.company_name,
	        CO.company_cd,
	        CO.biz_number,
	        CO.addr_kor
	    FROM TB_ORDER_MST O
		    INNER JOIN TB_CART C ON O.order_no = C.order_no
		    INNER JOIN TB_OIL_MST F ON C.fuel_id = F.fuel_id
		    INNER JOIN TB_USERS U ON O.user_no = U.user_no
		    INNER JOIN TB_COMPANIES CO ON U.company_cd = CO.company_cd
	    WHERE O.order_id = #{orderId}
	    ORDER BY C.cart_id ASC
		</select>
		
		<update id="modifyMemo">
			UPDATE TB_DOCUMENT_MST
			SET memo = #{memo}
			WHERE doc_id = #{docId}
		</update>
		
		<select id="getDocumentById" resultType="io.github.teamb.btob.dto.document.DocumentPreviewDTO">
			SELECT 
				d.doc_id,
				d.doc_no,
				d.doc_type,
				IFNULL(d.memo, '') AS memo,
				d.reg_dtime,
			    o.order_id,
			    o.order_no, 
			    o.order_status,
			    c.cart_id,
			    c.total_qty,
			    c.total_price,
			    c.fuel_id,
			    f.fuel_nm,
			    u.user_name
			FROM TB_DOCUMENT_MST d
			LEFT JOIN TB_ORDER_MST o ON d.order_id = o.order_id
			LEFT JOIN TB_CART c ON o.cart_id = c.cart_id
			LEFT JOIN TB_OIL_MST f ON c.fuel_id = f.fuel_id
			LEFT JOIN TB_USERS u ON d.owner_user_id = u.user_name
			WHERE d.doc_id = #{docId}
			ORDER BY d.doc_id DESC
		</select>
		
		<select id="getDocumentList" resultType="io.github.teamb.btob.dto.document.DocumentListDTO">
		    SELECT 
		        d.doc_id,
		        d.doc_no,
		        d.doc_type,
		        IFNULL(d.memo, '') AS memo,
		        d.reg_dtime,
		        u.user_name 
		    FROM TB_DOCUMENT_MST d
		    LEFT JOIN TB_USERS u ON d.owner_user_id = u.user_no
		    <where>
		    	<if test="docType != null and docType != ''">
			        AND doc_type = #{docType}
			    </if>
		    
		        <if test="keyword != null and keyword != ''">
		           	AND (
		                d.doc_no LIKE CONCAT('%', #{keyword}, '%')
		                OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
		            )
		        </if>
		    </where>
		    ORDER BY d.doc_id DESC
		</select>
</mapper>